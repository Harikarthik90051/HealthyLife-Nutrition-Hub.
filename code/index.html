<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthyLife Nutrition Hub - Full-Stack Application</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* BASE STYLES & TYPOGRAPHY */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s; 
        }

        body {
            background-color: #f0f4f8; 
            color: #333;
            line-height: 1.6;
        }

        /* --- DARK MODE STYLES --- */
        body.dark-mode {
            background-color: #1a1a1a;
            color: #f0f4f8;
        }

        body.dark-mode header, body.dark-mode footer { background: #0d47a1; }
        body.dark-mode section { background-color: #2c2c2c; box-shadow: 0 10px 30px rgba(255, 255, 255, 0.05); }
        body.dark-mode nav { background-color: #1565c0; box-shadow: 0 2px 5px rgba(255, 255, 255, 0.2); }
        body.dark-mode h2 { color: #90caf9; }
        body.dark-mode form { background: #333; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5); }
        body.dark-mode label { color: #90caf9; }
        body.dark-mode input, body.dark-mode select { background-color: #444; border-color: #555; color: #f0f4f8; }
        body.dark-mode .result { background: linear-gradient(135deg, #333, #444); border: 1px solid #1e88e5; color: #e3f2fd; }

        /* HEADER & NAVIGATION */
        header {
            background: #2e7d32; color: white; text-align: center; padding: 40px 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        header h1 { font-size: 3em; font-family: 'Montserrat', sans-serif; font-weight: 800; }
        .hero-banner {
            background-image: url('https://images.pexels.com/photos/1640772/pexels-photo-1640772.jpeg?auto=compress&cs=tinysrgb&dpr=3&h=720&w=1280');
            background-size: cover; background-position: center; height: 380px; width: 100%; border-bottom: 5px solid #4CAF50;
        }
        nav { 
            background-color: #388E3C; text-align: center; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
            position: sticky; top: 0; z-index: 100; display: flex; align-items: center; justify-content: flex-start;
        }
        nav a { color: white; text-decoration: none; margin: 0 20px; font-weight: 600; transition: color 0.3s; }
        
        /* Auth Status/Links Container */
        nav .auth-status {
            display: flex;
            align-items: center;
            margin-left: auto; 
            gap: 15px;
        }
        nav .welcome-message {
            color: #e8f5e9;
            font-weight: 500;
            font-size: 0.9em;
        }

        #theme-toggle { background-color: #f4a261; color: #fff; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: 600; transition: background-color 0.3s, transform 0.2s; }
        
        section { padding: 80px 20px; max-width: 1100px; margin: 30px auto; background-color: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        h2 { color: #2e7d32; margin-bottom: 30px; text-align: center; font-family: 'Montserrat', sans-serif; font-weight: 700; }

        /* --- LOGIN/SIGNUP STYLES --- */
        #login-section, #signup-section {
            background: #fdfdfd; 
            max-width: 400px; 
            padding: 50px 30px; 
            margin: 50px auto; 
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }
        #login-section input, #signup-section input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
        }
        #login-section button, #signup-section button {
            width: 100%;
            margin-top: 10px;
            padding: 15px;
            background-color: #f4a261; 
            color: white;
            font-weight: 700;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        
        body.dark-mode #login-section, body.dark-mode #signup-section { background: #2c2c2c; box-shadow: 0 5px 15px rgba(255, 255, 255, 0.1); }
        body.dark-mode #login-section input, body.dark-mode #signup-section input { background-color: #444; border-color: #555; color: #f0f4f8; }


        /* --- NUTRIENT ANALYSIS HUB STYLES --- */
        #analysis { background: linear-gradient(145deg, #e8f5e9, #dcefe0); padding: 50px; }
        .form-group { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; position: relative; }
        label { font-weight: 700; color: #1b5e20; flex-basis: 40%; text-align: left; margin-right: 15px; }
        input, select { flex-basis: 60%; padding: 12px; font-size: 1.05em; border: 1px solid #c8e6c9; border-radius: 8px; transition: all 0.3s ease; }

        /* NEW: CHART STYLES */
        .chart-container {
            display: flex;
            align-items: center;
            justify-content: space-around;
            gap: 20px;
            margin-top: 20px;
        }

        .pie-chart {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: conic-gradient(
                /* The colors are set dynamically by the JS function */
                #f44336 0deg 25%,   /* Protein (Red) */
                #2196F3 25% 75%,    /* Carbs (Blue) */
                #FFC107 75% 100%    /* Fat (Yellow) */
            );
            transition: all 0.5s ease;
        }

        .legend {
            list-style: none;
            padding: 0;
            text-align: left;
            font-size: 0.95em;
        }

        .legend li {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            font-weight: 500;
        }

        .legend-color {
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-right: 8px;
            border-radius: 2px;
        }

        .color-protein { background-color: #f44336; }
        .color-carb { background-color: #2196F3; }
        .color-fat { background-color: #FFC107; }

        /* Existing Table styles */
        .meal-plan-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .meal-plan-table th, .meal-plan-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        .meal-plan-table th { background-color: #4CAF50; color: white; }
        .meal-plan-table tr:nth-child(even) { background-color: #f2f2f2; }
        body.dark-mode .meal-plan-table tr:nth-child(even) { background-color: #383838; }
        body.dark-mode .meal-plan-table th { background-color: #1e88e5; }
        body.dark-mode .meal-plan-table td { border-color: #555; }
        
        /* Error/Loading */
        .error-message { color: #D32F2F; font-size: 0.85em; font-weight: 600; position: absolute; bottom: -20px; right: 0; text-align: right; width: 60%; padding-top: 5px; }
        .loading-text { text-align: center; font-size: 1.2em; color: #03a9f4; margin: 20px 0; font-weight: 600; }
        
        /* FOOTER */
        footer { background-color: #333; color: white; padding: 30px; margin-top: 50px; text-align: center; }

        @media (max-width: 768px) {
            .chart-container { flex-direction: column; }
            .pie-chart { margin-bottom: 20px; }
            nav a { margin: 0 10px; }
            nav .auth-status { gap: 8px; }
            .form-group { flex-direction: column; align-items: flex-start; }
            label, input, select { flex-basis: 100%; width: 100%; margin-right: 0; text-align: left; }
            .error-message { right: auto; left: 0; width: 100%; text-align: left; }
        }
    </style>
</head>
<body id="body">

    <header>
        <h1>HealthyLife Nutrition Hub</h1>
        <p>Advanced Diet Balancing & Nutrient Deficit Detection Platform</p>
    </header>
    
    <div class="hero-banner"></div>

    <nav>
        <a href="#about">About</a>
        <a href="#analysis" id="nav-analysis" style="display: none;">Nutrient Analysis Hub</a>
        <a href="#recommendations" id="nav-plan" style="display: none;">Personalized Plan</a>
        
        <div class="auth-status">
            <span id="user-status" class="welcome-message" style="display: none;"></span> 
            
            <a href="#login" id="nav-login">Login</a>
            <a href="#signup" id="nav-signup">Sign Up</a>
            
            <button id="logout-button" style="display: none; background-color: #D32F2F;" onclick="AuthApp.logout()">Logout</button>

            <button id="theme-toggle" onclick="NutritionApp.ThemeManager.toggleDarkMode()">üåô Toggle Dark Mode</button>
        </div>
    </nav>
    
    <section id="login" style="display: none;">
        <div id="login-section">
            <h2>Member Login</h2>
            <form id="loginForm">
                <input type="email" id="login-email" placeholder="Email Address" required>
                <input type="password" id="login-password" placeholder="Password" required>
                <button type="submit" id="login-btn">Log In</button>
                <p style="margin-top: 15px; font-size: 0.9em;">New user? <a href="#signup">Create an Account</a></p>
                <p id="login-error" class="error-message" style="position: static; text-align: center; margin-top: 10px;"></p>
            </form>
        </div>
    </section>

    <section id="signup" style="display: none;">
        <div id="signup-section">
            <h2>Create Account</h2>
            <form id="signupForm">
                <input type="text" id="signup-name" placeholder="Full Name" required>
                <input type="email" id="signup-email" placeholder="Email Address" required>
                <input type="password" id="signup-password" placeholder="Choose Password" required>
                <button type="submit" id="signup-btn">Sign Up</button>
                <p style="margin-top: 15px; font-size: 0.9em;">Already have an account? <a href="#login">Log In</a></p>
                <p id="signup-error" class="error-message" style="position: static; text-align: center; margin-top: 10px;"></p>
            </form>
        </div>
    </section>
    <section id="about">
        <h2>About Our Platform</h2>
        <p>
            Welcome to *HealthyLife Nutrition Hub* ‚Äî your intelligent platform for balanced living. We combine the *Mifflin-St Jeor formula* with expert nutritional guidelines to accurately predict your energy needs and generate a *personalized, 7-day meal plan* focused on correcting common *nutrient deficiencies* in children and adolescents.
        </p>
    </section>

    <section id="analysis">
        <h2>1. Nutrient Analysis Hub</h2>
        <p style="text-align: center; color: #03a9f4; font-weight: 600; margin-bottom: 25px;">
            *IMPORTANT:* Please use *Kilograms (kg)* for weight and *Centimeters (cm)* for height for accurate calculation.
        </p>
        <form id="calorieForm">
            <div class="form-group">
                <label for="age">Age (Years):</label>
                <input type="number" id="age" required min="1" oninput="NutritionApp.Validator.clearError('age')" onkeydown="NutritionApp.InputController.restrictInput(event, false)">
                <span id="age-error" class="error-message"></span>
            </div>

            <div class="form-group">
                <label for="gender">Gender:</label>
                <select id="gender" required onchange="NutritionApp.Validator.clearError('gender')">
                    <option value="">Select</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                </select>
                <span id="gender-error" class="error-message"></span>
            </div>

            <div class="form-group">
                <label for="weight">Weight (kg):</label>
                <input type="number" id="weight" required min="1" step="0.1" oninput="NutritionApp.Validator.clearError('weight')" onkeydown="NutritionApp.InputController.restrictInput(event, true)">
                <span id="weight-error" class="error-message"></span>
            </div>

            <div class="form-group">
                <label for="height">Height (cm):</label>
                <input type="number" id="height" required min="1" oninput="NutritionApp.Validator.clearError('height')" onkeydown="NutritionApp.InputController.restrictInput(event, false)">
                <span id="height-error" class="error-message"></span>
            </div>

            <div class="form-group">
                <label for="activity">Activity Level:</label>
                <select id="activity" required onchange="NutritionApp.Validator.clearError('activity')">
                    <option value="">Select</option>
                    <option value="1.2">Sedentary (Little or no exercise)</option>
                    <option value="1.375">Lightly active (1‚Äì3 days/week)</option>
                    <option value="1.55">Moderately active (3‚Äì5 days/week)</option>
                    <option value="1.725">Very active (6‚Äì7 days/week)</option>
                    <option value="1.9">Super active (Twice/day training)</option>
                </select>
                <span id="activity-error" class="error-message"></span>
            </div>

            <button type="button" onclick="NutritionApp.Calculator.calculateCalories()">Generate Personalized Plan</button>
        </form>

        <div class="result" id="result" style="display: none; margin-top: 30px;"></div>
    </section>

    <section id="recommendations">
        <h2>2. Personalized Recommendations (7-Day Plan)</h2>
        <p class="text-center" style="text-align: center; margin-bottom: 30px;">This plan is dynamically generated based on your calculated *Macronutrient Goals* to ensure optimal balance and energy.</p>
        
        <div id="dynamic-plan">
            <table class="meal-plan-table">
                <thead>
                    <tr>
                        <th>Day</th>
                        <th>Breakfast</th>
                        <th>Lunch</th>
                        <th>Dinner</th>
                        <th>Snack</th>
                    </tr>
                </thead>
                <tbody id="meal-plan-body">
                    <tr><td colspan="5" style="text-align: center; color: #777; padding: 20px;">*Please use the Nutrient Analysis Hub (Section 1) above to generate your plan.*</td></tr>
                </tbody>
            </table>
        </div>
    </section>

    <footer>
        &copy; 2025 HealthyLife Nutrition Hub | Designed for a Healthier You üåø
    </footer>

    <script>
        // --- MODULAR JAVASCRIPT STRUCTURE ---

        const NutritionApp = {
            // --- DATASET ---
            Meals: { 
                protein_meals: [
                    "Greek Yogurt (High Protein) with Berries", "Scrambled Eggs (3) & Whole-Grain Toast", "Tuna Salad (High Omega-3) on Crackers", 
                    "Lentil or Black Bean Soup", "Grilled Chicken Breast with Quinoa", "Baked Salmon with Saut√©ed Greens (Iron/D)", 
                    "Tofu Scramble with Bell Peppers"
                ],
                carb_meals: [
                    "Oatmeal (Fiber) with Banana & Maple Syrup", "Whole-Wheat Toast with Avocado & Tomato", "Brown Rice Bowl with Mixed Vegetables", 
                    "Sweet Potato Mash with a dash of Cinnamon", "Whole-Grain Pasta Salad with Light Vinaigrette", "Quinoa with Roasted Root Vegetables", 
                    "Whole-Grain Bagel with light Cream Cheese"
                ],
                fat_meals: [
                    "Handful of Walnuts & Almonds", "1/4 Avocado with sea salt", "Peanut Butter on Apple Slices", 
                    "Small serving of Cottage Cheese", "Hard-boiled Egg", "Cheese stick and a pear", 
                    "Olives and a few whole-grain crackers"
                ]
            },

            // --- API SIMULATION ---
            API: {
                fetchMealPlan: function(proteinGoal) {
                    console.log(API Call: Requesting meal plan data from simulated backend with protein goal: ${proteinGoal}g...);
                    
                    return new Promise((resolve, reject) => {
                        // Simulate network latency (2 seconds)
                        setTimeout(() => {
                            try {
                                const mealPlanHtml = NutritionApp.Calculator._generateMealPlanHTML(proteinGoal);
                                resolve(mealPlanHtml); 
                            } catch (error) {
                                reject("Error: The backend server failed to generate the meal plan.");
                            }
                        }, 2000); 
                    });
                }
            },
            
            // --- THEME MANAGER ---
            ThemeManager: {
                init: function() {
                    const savedTheme = localStorage.getItem('theme');
                    if (savedTheme === 'dark') {
                        document.body.classList.add('dark-mode');
                    }
                },
                toggleDarkMode: function() {
                    const isDark = document.body.classList.toggle('dark-mode');
                    if (isDark) {
                        localStorage.setItem('theme', 'dark');
                    } else {
                        localStorage.setItem('theme', 'light');
                    }
                }
            },
            
            // --- INPUT CONTROLLER ---
            InputController: {
                restrictInput: function(event, allowDecimal) {
                    const allowedKeys = [48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 8, 46, 9, 13, 37, 39, 36, 35];
                    const keyCode = event.keyCode;
                    
                    if (allowedKeys.includes(keyCode) || (event.ctrlKey || event.metaKey)) {
                        return true;
                    }

                    if (allowDecimal && (keyCode === 190 || keyCode === 110)) {
                        if (event.target.value.includes('.') && (keyCode === 190 || keyCode === 110)) {
                            event.preventDefault();
                        }
                        return true;
                    }
                    
                    if (keyCode === 109 || keyCode === 189) {
                         event.preventDefault();
                         return false;
                    }

                    event.preventDefault();
                    return false;
                }
            },

            // --- FORM VALIDATION MODULE ---
            Validator: {
                validateForm: function() {
                    let isValid = true;
                    const fields = ['age', 'gender', 'weight', 'height', 'activity'];
                    
                    fields.forEach(field => {
                        const inputElement = document.getElementById(field);
                        const errorElement = document.getElementById(${field}-error);
                        let value = inputElement.value.trim();

                        this.clearError(field); 

                        if (!value || value === "") {
                            errorElement.textContent = "This field is required.";
                            inputElement.style.borderColor = "#D32F2F"; 
                            isValid = false;
                            return;
                        }
                        
                        if ((inputElement.type === 'number' || inputElement.tagName === 'INPUT') && parseFloat(value) <= 0) {
                            errorElement.textContent = "Value must be positive.";
                            inputElement.style.borderColor = "#D32F2F";
                            isValid = false;
                        }
                    });

                    return isValid;
                },

                clearError: function(fieldId) {
                    document.getElementById(${fieldId}-error).textContent = "";
                    document.getElementById(fieldId).style.borderColor = ""; 
                }
            },

            // --- CALCULATOR LOGIC ---
            Calculator: {
                _generateMealPlanHTML: function(proteinGoal) {
                    const days = ["Day 1", "Day 2", "Day 3", "Day 4", "Day 5", "Day 6", "Day 7"];
                    let html = '';

                    for (let i = 0; i < 7; i++) {
                        let breakfast = NutritionApp.Meals.protein_meals[i % NutritionApp.Meals.protein_meals.length];
                        let lunch, dinner;
                        
                        if (i % 3 === 0) { 
                            lunch = NutritionApp.Meals.protein_meals[(i + 1) % NutritionApp.Meals.protein_meals.length] + " & small Carb side";
                            dinner = NutritionApp.Meals.protein_meals[(i + 2) % NutritionApp.Meals.protein_meals.length] + " & large Veggie side";
                        } else if (i % 3 === 1) {
                            lunch = NutritionApp.Meals.carb_meals[(i + 3) % NutritionApp.Meals.carb_meals.length] + " & small Protein side";
                            dinner = NutritionApp.Meals.carb_meals[(i + 4) % NutritionApp.Meals.carb_meals.length] + " & light Fat source";
                        } else {
                            lunch = NutritionApp.Meals.carb_meals[(i + 5) % NutritionApp.Meals.carb_meals.length] + " & half portion Protein";
                            dinner = NutritionApp.Meals.protein_meals[(i + 6) % NutritionApp.Meals.protein_meals.length] + " & half portion Carb";
                        }

                        let snack = NutritionApp.Meals.fat_meals[i % NutritionApp.Meals.fat_meals.length];

                        if (proteinGoal > 120) {
                            dinner = ü•© ${dinner} (High Protein Focus);
                        }

                        html += `
                            <tr>
                                <td>${days[i]}</td>
                                <td>${breakfast}</td>
                                <td>${lunch}</td>
                                <td>${dinner}</td>
                                <td>${snack}</td>
                            </tr>
                        `;
                    }
                    return html;
                },
                
                _getBmiStatus: function(bmi) {
                    if (bmi < 18.5) return { text: "Underweight", color: "#FFC107" }; 
                    if (bmi < 25) return { text: "Healthy Weight", color: "#4CAF50" }; 
                    if (bmi < 30) return { text: "Overweight", color: "#FF9800" }; 
                    return { text: "Obese", color: "#D32F2F" }; 
                },

                calculateCalories: async function() {
                    if (!AuthApp.currentUser) {
                        alert("Please log in to use the Nutrient Analysis Hub.");
                        AuthApp.handleRouting('#login');
                        return;
                    }

                    if (!NutritionApp.Validator.validateForm()) {
                        document.getElementById('result').style.display = 'none'; 
                        return;
                    }

                    // Get input values
                    const age = parseInt(document.getElementById('age').value);
                    const gender = document.getElementById('gender').value;
                    const weight = parseFloat(document.getElementById('weight').value); 
                    const heightCm = parseFloat(document.getElementById('height').value); 
                    const activity = parseFloat(document.getElementById('activity').value);
                    
                    const heightM = heightCm / 100; 

                    // 1. Calculate BMR (Mifflin-St Jeor)
                    let bmr;
                    if (gender === 'male') {
                        bmr = (10 * weight) + (6.25 * heightCm) - (5 * age) + 5;
                    } else {
                        bmr = (10 * weight) + (6.25 * heightCm) - (5 * age) - 161;
                    }

                    // 2. Calculate TDEE and Macros
                    const dailyCalories = bmr * activity;
                    const totalCalories = Math.round(dailyCalories);

                    // Default Macro Split: 25% Protein, 50% Carbs, 25% Fat
                    const proteinPercent = 25;
                    const carbPercent = 50;
                    const fatPercent = 25;
                    
                    const proteinGrams = Math.round((dailyCalories * (proteinPercent / 100)) / 4);
                    const fatGrams = Math.round((dailyCalories * (fatPercent / 100)) / 9);
                    const carbGrams = Math.round((dailyCalories * (carbPercent / 100)) / 4);
                    
                    // 3. Calculate BMI
                    const bmi = weight / (heightM * heightM);
                    const roundedBmi = parseFloat(bmi.toFixed(2));
                    const bmiStatus = this._getBmiStatus(roundedBmi);

                    // --- STEP 3: DISPLAY CALCULATION RESULTS (Immediately) ---
                    this._displayResults(totalCalories, proteinGrams, carbGrams, fatGrams, proteinPercent, carbPercent, fatPercent, age, roundedBmi, bmiStatus);

                    // --- STEP 4: FETCH MEAL PLAN (Async part) ---
                    const mealPlanBody = document.getElementById('meal-plan-body');
                    mealPlanBody.innerHTML = '<tr><td colspan="5" class="loading-text">üîÑ Loading Personalized Plan from Server...</td></tr>';
                    
                    try {
                        const mealPlanHtml = await NutritionApp.API.fetchMealPlan(proteinGrams);
                        mealPlanBody.innerHTML = mealPlanHtml;
                    } catch (error) {
                        console.error("Meal Plan Fetch Error:", error);
                        mealPlanBody.innerHTML = `<tr><td colspan="5" class="error-message" style="position: static; text-align: center; padding: 20px;">
                            ‚ùå ERROR: Could not retrieve plan. Server simulation failed. Please try again.
                        </td></tr>`;
                    }
                },

                _displayResults: function(dailyCalories, proteinGrams, carbGrams, fatGrams, proteinPercent, carbPercent, fatPercent, age, bmi, bmiStatus) {
                    const resultDiv = document.getElementById('result');
                    resultDiv.style.display = 'block';

                    let warning = '';
                    let statusColor = bmiStatus.color;

                    if (age >= 4 && age < 18) {
                        warning = '<p style="color: #D32F2F; font-weight: 700; margin-top: 15px;"><strong>‚ö† Deficiency Focus for Growth:</strong> Ensure focused intake of *Iron, Calcium, and Vitamin D*.</p>';
                    } else if (age < 4) {
                         warning = '<p style="color: #D32F2F; font-weight: 700; margin-top: 15px;"><strong>‚ö† Pediatric Nutrition:</strong> Consult a pediatrician or registered dietitian for accurate guidelines.</p>';
                    }

                    // Calculate CSS for the Conic Gradient Pie Chart
                    const proteinEnd = proteinPercent;
                    const carbStart = proteinEnd;
                    const carbEnd = carbStart + carbPercent;
                    const fatStart = carbEnd;
                    const fatEnd = fatStart + fatPercent;

                    const pieChartStyle = `
                        background: conic-gradient(
                            #f44336 0% ${proteinEnd}%,
                            #2196F3 ${carbStart}% ${carbEnd}%,
                            #FFC107 ${fatStart}% ${fatEnd}%
                        );
                    `;


                    resultDiv.innerHTML = `
                        <h3>Your Personalized Health Metrics:</h3>
                        <p style="font-size: 1.1em; margin-bottom: 5px;">Body Mass Index (BMI): <strong>${bmi}</strong></p>
                        <p style="font-size: 1.2em; color: ${statusColor}; font-weight: 700; margin-bottom: 20px;">Health Status: ${bmiStatus.text}</p>
                        <hr style="margin: 15px 0; border-color: #eee;">
                        
                        <h3>Estimated Daily Nutrition Goals:</h3>
                        <p>Estimated Daily Calorie Need (TDEE): <strong>${dailyCalories} kcal</strong></p>
                        
                        <div class="chart-container">
                            <div class="pie-chart" style="${pieChartStyle}"></div>
                            
                            <ul class="legend">
                                <li><span class="legend-color color-protein"></span>Protein: <strong>${proteinGrams}g</strong> (${proteinPercent}%)</li>
                                <li><span class="legend-color color-carb"></span>Carbohydrates: <strong>${carbGrams}g</strong> (${carbPercent}%)</li>
                                <li><span class="legend-color color-fat"></span>Fat: <strong>${fatGrams}g</strong> (${fatPercent}%)</li>
                            </ul>
                        </div>
                        ${warning}
                    `;
                    document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
                }
            },
            
            // --- INITIALIZATION ---
            init: function() {
                this.ThemeManager.init();
            }
        };

        // --- AUTHENTICATION MODULE ---
        const AuthApp = {
            currentUser: null,

            init: function() {
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    this.currentUser = JSON.parse(savedUser);
                }
                this.setupListeners();
                this.handleRouting();
            },

            setupListeners: function() {
                document.getElementById('loginForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.login(document.getElementById('login-email').value, document.getElementById('login-password').value);
                });
                document.getElementById('signupForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.signup(document.getElementById('signup-email').value, document.getElementById('signup-password').value, document.getElementById('signup-name').value);
                });
                window.addEventListener('hashchange', () => this.handleRouting());
            },

            // SIMULATED AUTHENTICATION
            login: function(email, password) {
                document.getElementById('login-error').textContent = '';
                document.getElementById('login-btn').textContent = 'Authenticating...';
                
                setTimeout(() => {
                    if (email && password.length >= 6) {
                        this.currentUser = { email: email, name: email.split('@')[0] }; 
                        localStorage.setItem('currentUser', JSON.stringify(this.currentUser)); 
                        this.handleRouting();
                    } else {
                        document.getElementById('login-error').textContent = 'Invalid credentials or password too short.';
                    }
                    document.getElementById('login-btn').textContent = 'Log In';
                }, 1000);
            },

            signup: function(email, password, name) {
                document.getElementById('signup-error').textContent = '';
                document.getElementById('signup-btn').textContent = 'Creating...';

                if (password.length < 6) {
                    document.getElementById('signup-error').textContent = 'Password must be at least 6 characters.';
                    document.getElementById('signup-btn').textContent = 'Sign Up';
                    return;
                }

                setTimeout(() => {
                    this.currentUser = { email: email, name: name || email.split('@')[0] };
                    localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                    this.handleRouting();
                }, 1000);
            },

            logout: function() {
                localStorage.removeItem('currentUser');
                this.currentUser = null;
                this.handleRouting('#login'); // Redirect to login
            },

            // SIMULATED PROTECTED ROUTING
            handleRouting: function(hashOverride) {
                const hash = hashOverride || window.location.hash;
                const loggedIn = !!this.currentUser;
                const userStatusElement = document.getElementById('user-status');
                
                // 1. Update Navigation UI
                document.getElementById('nav-analysis').style.display = loggedIn ? '' : 'none';
                document.getElementById('nav-plan').style.display = loggedIn ? '' : 'none';
                document.getElementById('nav-login').style.display = loggedIn ? 'none' : '';
                document.getElementById('nav-signup').style.display = loggedIn ? 'none' : '';
                document.getElementById('logout-button').style.display = loggedIn ? '' : 'none';
                userStatusElement.style.display = loggedIn ? '' : 'none';
                if (loggedIn) {
                    userStatusElement.textContent = Welcome, ${this.currentUser.name}!;
                }

                // Hide all main sections by default
                document.querySelectorAll('section').forEach(section => {
                    section.style.display = 'none';
                });

                // 2. Determine which section to show
                let targetSectionId = '#about'; // Default landing page

                if (loggedIn) {
                    if (hash === '#analysis' || hash === '#recommendations' || hash === '#about' || hash === '') {
                        targetSectionId = hash || '#about';
                    } else {
                        // Logged in, but tried to access /login or /signup directly
                        targetSectionId = '#analysis';
                        window.location.hash = '#analysis';
                    }
                } else {
                    // Not logged in (Protected Route Logic)
                    if (hash === '#login' || hash === '#signup' || hash === '#about') {
                        targetSectionId = hash;
                    } else {
                        // Tried to access a protected route or root
                        targetSectionId = '#login';
                        window.location.hash = '#login';
                    }
                }
                
                // 3. Show the target section
                const targetElement = document.querySelector(targetSectionId);
                if (targetElement) {
                    targetElement.style.display = 'block';
                }
            }
        };

        // Call init when the DOM content is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            NutritionApp.init();
            AuthApp.init(); 
        });
    </script>

</body>
</html>
